PAD Corporation                                                  Alexis Seymour
Category: Game Documentation                                   Diego Pintat-Gil
                                                                     Loris Gode
                                                                   Perrine Feyt
                                                                 Keyvan Goddard
                                                                     April 2025

                               R-Type Protocol
  

Table of Contents  
-----------------  
1. Introduction  
2. Frame Structure TCP
3. Frame Structure UDP
4. Opcode Definitions  
5. Payload Length  
6. Extended Payload Length  
7. Payload Data
8. Security Considerations 
9. References  


1. Introduction  
---------------

This document describes the low-level framing format for messages exchanged
over a socket based communication system. It includes specifications for
the opcode, payload length, and extended fields, enabling reliable and
extensible client-server interaction. 

This format exists because we needed to create a network communication protocol
to use in a multiplayer game inspired by R-Type.

Moreover this document contains the format of the files that can be used by the
server to generate the game's map.

2. Frame Structure for TCP
------------------

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1      ...
+---------------+---------------+-------------------------------+-------------+
|     opcode    |  Payload len  |      Extended Payload len     |   Payload   |
|      (8)      |      (8)      |          (16/64) bits         |    Data     |
|               |               |                               |    (...)    |
|               |               |                               |             |
+---------------+---------------+-------------------------------+-------------+

Each message consists of the following fields:

- Opcode (8 bits): Instruction or message type identifier.  
- Payload Length (8 bits): Indicates the size of the Payload field.  
- Extended Payload Length (optional): Used if Payload Length exceeds 253.  
- Payload: The actual message data.


3. Frame Structure UDP
----------------------

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1      ...
+---------------+---------------+-------------------------------+-------------+
|     opcode    |                                                             |
|      (8)      |                      Payload                                |
|               |                                                             |
|               |                                                             |
+---------------+---------------+-------------------------------+-------------+

Each message consists of the following fields:

- Opcode (8 bits): Instruction or message type identifier.  
- Payload: The actual message data.


3. Opcode Definitions  
---------------------  

The `Opcode` field defines the type of message being transmitted. The following
opcodes are currently defined:

---- Connection management ----


OPCODE_CODE_UDP = 0x00;
  [SERVER → CLIENT, TCP]
  Sent by the server to transmit the unique "UDP code" that allows the client
  to authenticate itself on the UDP socket.
  Payload: [ code_udp (4 bytes) ]
  Purpose: links the TCP connection with the UDP endpoint.

 OPCODE_CLOSE_CONNECTION = 0x01;
  [BIDIRECTIONAL]
  Tells the receiver to gracefully close the connection.
  Payload: none
  Purpose: clean disconnect, either client-initiated or server-initiated.

 OPCODE_INCOMPLETE_DATA = 0x02;
  [SERVER → CLIENT, TCP]
  Informs the client that the last packet was incomplete or invalid.
  Payload: [ missing_length (2 bytes) ]
  Purpose: client should resend the missing data.

---- Authentication / Identification ----

 OPCODE_UDP_AUTH = 0x10;
  [CLIENT → SERVER, UDP]
  First UDP message sent by the client to authenticate its datagrams.
  Payload: [ code_udp (4 bytes) ]
  Purpose: lets the server associate the client's UDP (IP:port) with its TCP identity.

 OPCODE_PLAYER_ID = 0x11;
  [SERVER → SERVER, TCP]
  Give playerId to client
  Payload: [ code_udp (4 bytes) ]
  Purpose: lets the client stock his id.

---- Game data ----

 OPCODE_UPDATE_ENTITIES = 0x21;
  [SERVER → CLIENT, UDP]
  Sends the updated world state (positions of other players, entities, etc).
  Payload: compressed list of visible entities.

 OPCODE_PLAYER_INPUT = 0x26;
  [CLIENT → SERVER, UDP]
  Sends the client kb input.

 OPCODE_ENTITY_CREATE = 0x27;
  [SERVER → CLIENT, TCP]
  Création complète d'une entité avec tous ses composants
  Payload: entité sérialisée complète

 OPCODE_ENTITY_DESTROY = 0x28;
  [SERVER → CLIENT, TCP]
  Destruction d'une entité
  Payload: EntityID (4 bytes)

 OPCODE_CHAT_MESSAGE = 0x30;
  [CLIENT → SERVER, TCP]
  Sends a text message (global or private).
  Payload: [ target (1 byte: 0 = global, 1 = private) | msg (string) ]

 OPCODE_CHAT_BROADCAST = 0x31;
  [SERVER → CLIENT, TCP]
  Broadcast chat message to all players.
  Payload: [ sender_id (4 bytes) | msg (string) ]

-----Lobby / Pre-game info ----

 OPCODE_GAME_OVER = 0x32;
  [SERVER → CLIENT, TCP]
  Notify clients that the game is over.
  Payload: [ winner_id (4 bytes) ]
  Purpose: clients can display end-of-game screen with winner info.

 OPCODE_PLAYER_DEAD = 0x33;
  [SERVER → CLIENT, TCP]
  Notify clients that a specific player has died.
  Payload: [ player_id (4 bytes) ]
  Purpose: clients can update UI, respawn logic, etc.

 OPCODE_UPDATE_WAVE = 0x50;
  [SERVER → CLIENT, TCP]
  Update current wave counter
  Payload: WaveNumber (4 bytes)

 OPCODE_UPDATE_SCORE = 0x51;
  [SERVER → CLIENT, TCP]
  Update clients score
  Payload:  compressed list of all clients' score. (playerId: 4 byte, score 4 byte)

 OPCODE_LOBBY_INFO = 0x60;
  [SERVER → CLIENT, TCP]
  Sends information about the lobby, e.g., number of players ready.
  Payload: [ players_ready (1 byte) | total_players (1 byte) ]
  Purpose: client can display lobby info, like "players ready: X / Y".

 OPCODE_GAME_STATE_UPDATE = 0x61;
  [SERVER → CLIENT, TCP]
  Sends info about game state (INGAME or INLOBBY)

 OPCODE_KICK_NOTIFICATION = 0x62;
  [SERVER → CLIENT, TCP]
  Notifies the client that it has been kicked from the server.
  Payload: none

 OPCODE_BAN_NOTIFICATION = 0x63;
  [SERVER → CLIENT, TCP]
  Notifies the client's ip that it has been ban from the server.
  Payload: none

 OPCODE_CREATE_LOBBY = 0x70;
  [CLIENT → SERVER, TCP]
  Request to create a new lobby
  Payload: lobby_name (string)

 OPCODE_JOIN_LOBBY = 0x71;
  [CLIENT → SERVER, TCP]
  Request to join an existing lobby
  Payload: lobby_name player_name (string string)

 OPCODE_LOBBY_CREATED = 0x72;
  [SERVER → CLIENT, TCP]
  Confirmation that lobby was created
  Payload: lobby_name (string)

 OPCODE_LOBBY_JOINED = 0x73;
  [SERVER → CLIENT, TCP]
  Confirmation that player joined lobby
  Payload: lobby_name (string)

 OPCODE_LOBBY_ERROR = 0x74;
  [SERVER → CLIENT, TCP]
  Error joining/creating lobby
  Payload: error_message (string)

 OPCODE_GAME_LOBBY = 0x76;
  [CLIENT → SERVER, TCP]
  Request to join an existing lobby
  Payload: player_name (string)

 OPCODE_LOGIN_REQUEST = 0x80;
  [CLIENT → SERVER, TCP]
  Send login credentials to server
  Payload: [ username (string) | password (string) ]

 OPCODE_LOGIN_RESPONSE = 0x81;
  [SERVER → CLIENT, TCP]
  Login response from server
  Payload: [ success (1 byte: 0 = failure, 1 = success) | message (string) ]

 OPCODE_SIGNIN_REQUEST = 0x82;
  [CLIENT → SERVER, TCP]
  Sends sign-in credentials to the server.
  Payload: [ username (string) | password (string) ]

 OPCODE_SIGNIN_RESPONSE = 0x83;
  [SERVER → CLIENT, TCP]
  Signin response from server
  Payload: [ success (1 byte: 0 = failure, 1 = success) | message (string) ]

 OPCODE_SERVER_PUB_KEY = 0x90;
  [SERVER → CLIENT, TCP]
  AES server key
  Payload: [ success (1 byte: 0 = failure, 1 = success) | message (string) ]

 OPCODE_CLIENT_IV_KEY = 0x92;
  [SERVER → CLIENT, TCP]
  Client sends generated AES key and key to server
  Payload: [ AES_KEY (256 bytes) || IV (16 bytes) ]

 OPCODE_VOICE_DATA = 0x75;
  [CLIENT → SERVER, UDP]
  Sends the client's voice data.
  Payload: [ user_id (4 bytes) | audio_data (byte array) ]

 OPCODE_BONUS = 0x93;
  [SERVER → CLIENT, TCP]
  Client got bonus
  Payload: none

 OPCODE_NEW_WAVE = 0x94;
  [SERVER → CLIENT, TCP]
  New wave alert
  Payload: none

 OPCODE_EXPLOSION = 0x95;
  [SERVER → CLIENT, TCP]
  Explosion
  Payload: none


4. Payload Length  
-----------------  

The `Payload Length` field determines how the payload size is encoded:

- Values `0-253`: Actual length in bytes.  
- Value `254`: Payload length is encoded in the next 2 bytes (16 bits).  
- Value `255`: Payload length is encoded in the next 8 bytes (64 bits).

This dynamic sizing enables the transmission of both small and large payloads
efficiently.

5. Extended Payload Length  
---------------------------  

If the payload exceeds 253 bytes:

- A 16-bit unsigned integer follows when the length is 254–65535 bytes.  
- A 64-bit unsigned integer follows for payloads larger than 65535 bytes.

This structure ensures compatibility with large datasets while maintaining 
lightweight overhead for smaller transmissions.

6. Payload Data  
---------------  

The `Payload` field contains the actual message data relevant to the context 
established by the Opcode. The interpretation of this field is Opcode-dependent
and may include numeric data, serialized classes, coordinates, or instructions.

7. Security Considerations  
--------------------------  

This protocol does not define authentication or encryption mechanisms.
Implementations SHOULD validate input data and avoid processing
incomplete payloads to prevent buffer overflows or denial-of-service 
conditions.



8. References  
-------------  

- [RFC 6455] IETF, "The WebSocket Protocol"
    * https://datatracker.ietf.org/doc/html/rfc6455
- [RFC 7322] IETF, "RFC Style Guide"
    * https://datatracker.ietf.org/doc/html/rfc7322  

Author's Address
----------------  

Diego Pintat-Gil
diego.pintat-gil@epitech.eu
